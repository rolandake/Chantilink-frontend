import{b as h,c as D,i as M,j as I,k as P}from"./chunk-KBFS2P5K.js";var m=(e,n)=>n.some(t=>e instanceof t),L,g;function j(){return L||(L=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function A(){return g||(g=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}var B=new WeakMap,l=new WeakMap,f=new WeakMap;function O(e){let n=new Promise((t,r)=>{let i=()=>{e.removeEventListener("success",c),e.removeEventListener("error",o)},c=()=>{t(a(e.result)),i()},o=()=>{r(e.error),i()};e.addEventListener("success",c),e.addEventListener("error",o)});return f.set(n,e),n}function v(e){if(B.has(e))return;let n=new Promise((t,r)=>{let i=()=>{e.removeEventListener("complete",c),e.removeEventListener("error",o),e.removeEventListener("abort",o)},c=()=>{t(),i()},o=()=>{r(e.error||new DOMException("AbortError","AbortError")),i()};e.addEventListener("complete",c),e.addEventListener("error",o),e.addEventListener("abort",o)});B.set(e,n)}var w={get(e,n,t){if(e instanceof IDBTransaction){if(n==="done")return B.get(e);if(n==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return a(e[n])},set(e,n,t){return e[n]=t,!0},has(e,n){return e instanceof IDBTransaction&&(n==="done"||n==="store")?!0:n in e}};function S(e){w=e(w)}function W(e){return A().includes(e)?function(...n){return e.apply(b(this),n),a(this.request)}:function(...n){return a(e.apply(b(this),n))}}function p(e){return typeof e=="function"?W(e):(e instanceof IDBTransaction&&v(e),m(e,j())?new Proxy(e,w):e)}function a(e){if(e instanceof IDBRequest)return O(e);if(l.has(e))return l.get(e);let n=p(e);return n!==e&&(l.set(e,n),f.set(n,e)),n}var b=e=>f.get(e);function $(e,n,{blocked:t,upgrade:r,blocking:i,terminated:c}={}){let o=indexedDB.open(e,n),d=a(o);return r&&o.addEventListener("upgradeneeded",s=>{r(a(o.result),s.oldVersion,s.newVersion,a(o.transaction),s)}),t&&o.addEventListener("blocked",s=>t(s.oldVersion,s.newVersion,s)),d.then(s=>{c&&s.addEventListener("close",()=>c()),i&&s.addEventListener("versionchange",u=>i(u.oldVersion,u.newVersion,u))}).catch(()=>{}),d}function z(e,{blocked:n}={}){let t=indexedDB.deleteDatabase(e);return n&&t.addEventListener("blocked",r=>n(r.oldVersion,r)),a(t).then(()=>{})}var F=["get","getKey","getAll","getAllKeys","count"],k=["put","add","delete","clear"],y=new Map;function C(e,n){if(!(e instanceof IDBDatabase&&!(n in e)&&typeof n=="string"))return;if(y.get(n))return y.get(n);let t=n.replace(/FromIndex$/,""),r=n!==t,i=k.includes(t);if(!(t in(r?IDBIndex:IDBObjectStore).prototype)||!(i||F.includes(t)))return;let c=function(o,...d){return M(this,null,function*(){let s=this.transaction(o,i?"readwrite":"readonly"),u=s.store;return r&&(u=u.index(d.shift())),(yield Promise.all([u[t](...d),i&&s.done]))[0]})};return y.set(n,c),c}S(e=>D(h({},e),{get:(n,t,r)=>C(n,t)||e.get(n,t,r),has:(n,t)=>!!C(n,t)||e.has(n,t)}));var K=["continue","continuePrimaryKey","advance"],x={},E=new WeakMap,T=new WeakMap,N={get(e,n){if(!K.includes(n))return e[n];let t=x[n];return t||(t=x[n]=function(...r){E.set(this,T.get(this)[n](...r))}),t}};function R(...e){return P(this,null,function*(){let n=this;if(n instanceof IDBCursor||(n=yield new I(n.openCursor(...e))),!n)return;n=n;let t=new Proxy(n,N);for(T.set(t,n),f.set(t,b(n));n;)yield t,n=yield new I(E.get(t)||n.continue()),E.delete(t)})}function V(e,n){return n===Symbol.asyncIterator&&m(e,[IDBIndex,IDBObjectStore,IDBCursor])||n==="iterate"&&m(e,[IDBIndex,IDBObjectStore])}S(e=>D(h({},e),{get(n,t,r){return V(n,t)?R:e.get(n,t,r)},has(n,t){return V(n,t)||e.has(n,t)}}));export{z as deleteDB,$ as openDB,b as unwrap,a as wrap};
//# sourceMappingURL=idb.js.map
